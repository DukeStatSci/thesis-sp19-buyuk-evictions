---
title: "EDA 2"
author: "Ekim Buyuk"
date: "2/12/2019"
output: pdf_document
---

```{r library}
if (!require("readxl")) install.packages("readxl")
library(readxl)
if (!require("MASS")) install.packages("MASS")
library(MASS)
if (!require("sf")) install.packages("sf")
library(sf)
if (!require("ggplot2")) install.packages("ggplot2")
library(ggplot2)
if (!require("stringr")) install.packages("stringr")
library(stringr)
if (!require("tidyr")) install.packages("tidyr")
library(tidyr)
if (!require("mapview")) install.packages("mapview")
library(mapview)
if (!require("purrr")) install.packages("purrr")
library(purrr)
if (!require("xgboost")) install.packages("xgboost")
library(xgboost)
if (!require("dplyr")) install.packages("dplyr")
library(dplyr)
if (!require("FedData")) install.packages("FedData")
library(FedData)
if (!require("tidyverse")) install.packages("tidyverse")
library(tidyverse)
if (!require("tidycensus")) install.packages("tidycensus")
library(tidycensus)
if (!require("fuzzyjoin")) install.packages("fuzzjoin")
library(fuzzyjoin)
if (!require("lubridate")) install.packages("lubridate")
library(lubridate)
if (!require("lme4")) install.packages("lme4")
library(lme4)
if (!require("glmm")) install.packages("glmm")
library(glmm)
if (!require("spdep")) install.packages("spdep")
library(spdep)
if (!require("xlsx")) install.packages("xlsx")
library(xlsx)
if (!require("fuzzyjoin")) install.packages("fuzzyjoin")
library(fuzzyjoin)
knitr::opts_chunk$set(cache=TRUE, echo=F, warning=F, message=F)
options(warn = -1)

```

```{r data}
census_tract_eda = sf::st_read("census_2010_nc_tract", quiet = TRUE, stringsAsFactors = FALSE) %>% filter(CNTY_FIPS == "063")
census_sf_eda = sf::st_read("census_sf", quiet = TRUE, stringsAsFactors = FALSE)
complete_data_eda <-  sf::st_read("complete_data", quiet = TRUE, stringsAsFactors = FALSE)
durham_apts <- read.csv("new_durham_apts_edited_plus_nas_covered.csv")
complete_data <- sf::st_read("complete_data", quiet = TRUE, stringsAsFactors = FALSE)
```

# Picking Committee Members
??

You should be finalizing your committees now (you need 3 members determined in consultation with your committee chair). Once the committee is finalized, please go ahead and schedule a one-hour time for your thesis defense. Faculty members typically have tight schedules, with frequent work travel, so that you may be surprised how challenging it can be to find a one hour time in which everyone is free â€“ especially at the end of the semester, when many students are scheduling presentations. The last day to defend your thesis is Thursday, April 18. Your committee must provide feedback regarding your (hopefully successful!) completion of your presentation to the DUS by Saturday, April 20, to facilitate the determination of honors. (In the coming weeks, you will receive more information regarding how the honors level is determined.)

I am an undergrad doing a senior thesis. Would you be willing to serve on my committee? 
Econ adviser shud also be on it. no requirement that everyone be stats affiliated. 
Maybe ask amy to join, mine been asked but ask her as well. 
Anyone else: Jim Clark -> maybe ask him! he can come join!

second email, ask about 9-5time. set up a doodle poll and see what works. change the committee slightly if there is.
2 week window in april. - draft, not final necesssarily. it will be due later. quite close and then due later. 
if something serious comes up, address in dissertation. 

# Evictions

```{r}
evic_by_year = complete_data_eda %>% count(year)

#Plot of Evictions By Year
evics_by_year_plot <- ggplot(data=evic_by_year, aes(x=year, y=n)) +
  geom_bar(stat = "identity") +
  ggtitle("Number of Evictions In Multi-Family Dwellings by Year")

evics_by_year_plot
```

# Evictions By Date Served
```{r}
evic_ds_2018 = complete_data %>% filter(substr(Dateissued,1,4) == "2018") %>% count(Dateissued)

evic_ds_2018_plot <- ggplot(evic_ds_2018, aes(Dateissued, n)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  ggtitle("Evictions in 2018 Based on Date Served")

evic_ds_2018_plot

sum(evic_ds_2018$n)
sum(evic_2018$n)
head(evic_ds_2018[order(-evic_ds_2018$n),],5)

parcels_evicting_nov_16 <- complete_data %>% filter(Dateissued == "2018-11-16") %>% group_by(PARCEL_ID) %>% count()

head(parcels_evicting_nov_16[order(-parcels_evicting_nov_16$n),],5)

parcel_152986 <- complete_data %>% filter(PARCEL_ID == "152986") %>% count(Dateissued)

ggplot(parcel_152986, aes(Dateissued, n)) +
  geom_line() +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %y") +
  ylim(0,30) +
  ggtitle("Evictions for Parcel 152986")

parcel_152986_owner <- complete_data %>% filter(PARCEL_ID == "152986") %>% group_by(Umbrella.Name) %>% count(Mailing.Office.State)

parcel_152986_owner
```

# Checking Out Evictions By Date Served 

```{r}
evic_ds_by_date = complete_data %>% count(Dateissued)

ggplot(evic_ds_by_date, aes(Dateissued, n)) +
  geom_line() +
  scale_x_date(date_breaks = "1 year", date_labels = "%y") +
  ylim(0,150) +
  ggtitle("Evictions By Date Based on Date Served")
```

Again, we see that there is missing data in 2003. We also see that there is a similar cyclical pattern. That being said, we don't have as many observations: 19,127 of the 63,602 eviction records are NAs. 

```{r}
abnorm_evic <- complete_data %>% filter(is.na(Dateissued) == FALSE) %>% group_by(Dateissued,PARCEL_ID) %>% count()

head(abnorm_evic[order(-abnorm_evic$n),],5)

abnorm_evic_status <- complete_data %>% group_by(Statusdate,PARCEL_ID) %>% count()

head(abnorm_evic_status[order(-abnorm_evic_status$n),],5)

```

# Demographics 

```{r}
evics_by_parcel_year_count <- read.csv("evics_by_parcel_year_count.csv")

ggplot(data = evics_by_parcel_year_count, aes(aa_rate,evic_rate, colour=as.character(year))) +
  geom_point() +
  geom_smooth(se=FALSE) +
  ggtitle("Correlation Between Eviction Rates and Percent African American in Tracts Across Years")

ggplot(data = evics_by_parcel_year_count, aes(evic_rate,hispan_rate, colour=as.character(year))) +
  geom_point() +
  geom_smooth(se=FALSE) +
  ggtitle("Correlation Between Eviction Rates and Percent Hispanic in Tracts Across Years")

ggplot(data = evics_by_parcel_year_count, aes(evic_rate,hsehld_inc, colour=as.character(year))) +
  geom_point() +
  geom_smooth(se=FALSE) +
  ggtitle("Correlation Between Eviction Rates and Household Income in Tracts Across Years")

ggplot(data = evics_by_parcel_year_count, aes(year,evic_rate, colour=as.character(TRACT))) +
  geom_point() +
  geom_smooth(se=FALSE) +
  ggtitle("Eviction Rates in Tracts Across Years")
```


```{r}
evics_by_parcel_year_count$year_labels <-
  ifelse(evics_by_parcel_year_count$year==2004 | evics_by_parcel_year_count$year==2005 | evics_by_parcel_year_count$year==2006 | evics_by_parcel_year_count$year==2007, "pre_fin_crisis",
  ifelse(evics_by_parcel_year_count$year==2008 | evics_by_parcel_year_count$year==2009 | evics_by_parcel_year_count$year==2010 | evics_by_parcel_year_count$year==2011, "fin_crisis",
  ifelse(evics_by_parcel_year_count$year==2012 | evics_by_parcel_year_count$year==2013 | evics_by_parcel_year_count$year==2014 | evics_by_parcel_year_count$year==2015 | evics_by_parcel_year_count$year==2016 | evics_by_parcel_year_count$year==2017, "post_fin_crisis",
  ifelse(evics_by_parcel_year_count$year==2018, "year_2018", NA
         ))))

ggplot(data = evics_by_parcel_year_count, aes(aa_rate,log(evic_rate), colour=as.character(year_labels))) +
  geom_point() +
  geom_smooth(se=FALSE) +
  ggtitle("Correlation Between Eviction Rates and Percent African American in Tracts Across Time Periods")

ggplot(data = evics_by_parcel_year_count, aes(aa_rate,evic_rate, colour=as.character(year_labels))) +
  geom_point() +
  geom_smooth(se=FALSE) +
  ggtitle("Correlation Between Eviction Rates and Percent African American in Tracts Across Time Periods")

ggplot(data = evics_by_parcel_year_count, aes(hsehld_inc,evic_rate, colour=as.character(year_labels))) +
  geom_point() +
  geom_smooth(se=FALSE) +
  ggtitle("Correlation Between Eviction Rates and Household Income in Tracts Across Time Periods")

```
#check out this tract^^

#Different Dwelling Size Label Classifications 

```{r}
apt_evictions_eda$unit_sizes <- NA

for (i in 1:length(apt_evictions_eda$dwelling_count)) {
  if (apt_evictions_eda$dwelling_count[i] <= 5) {
    apt_evictions_eda$unit_sizes[i] = "tiny"
  }
  if (5 < apt_evictions_eda$dwelling_count[i] & apt_evictions_eda$dwelling_count[i] <= 24) {
    apt_evictions_eda$unit_sizes[i] = "small"
  }
  if (24 < apt_evictions_eda$dwelling_count[i] & apt_evictions_eda$dwelling_count[i] <= 50) {
    apt_evictions_eda$unit_sizes[i] = "medium"
  }
  if (50 < apt_evictions_eda$dwelling_count[i]) {
    apt_evictions_eda$unit_sizes[i] = "large"
  }
}

apt_evictions_eda$weekly_rate_by_size <- NA
apt_evictions_eda$weekly_rate_by_size <- apt_evictions_eda$total_evictions/as.numeric(apt_evictions_eda$ownership_time)
apt_evictions_eda$weekly_rate_by_size[is.na(apt_evictions_eda$weekly_rate_by_size)] <- 0

average_weekly_evic_rates <- apt_evictions_eda %>% group_by(RHFS.Classifications,unit_sizes) %>% summarise(mean_rate = mean(weekly_rate_by_size),
              sd_rate = sd(weekly_rate_by_size),
              max_rate = max(weekly_rate_by_size),
              min_rate = min(weekly_rate_by_size),
              total_owners = n())    

by_state <- apt_evictions_eda %>% group_by(Mailing.Office.State,unit_sizes) %>% summarise(mean_rate = mean(weekly_rate_by_size),
              sd_rate = sd(weekly_rate_by_size),
              max_rate = max(weekly_rate_by_size),
              min_rate = min(weekly_rate_by_size),
              total_owners = n())    

average_weekly_evic_rates = average_weekly_evic_rates %>% filter(
  RHFS.Classifications == "Individual" | RHFS.Classifications == "REIT" | 
    RHFS.Classifications == "LLP, LP, or LLC")

# Eviction Rates Across Different Types of Owners and Properties 

ggplot(data = average_weekly_evic_rates, aes(RHFS.Classifications,mean_rate, colour=as.character(unit_sizes))) +
  geom_bar(stat="identity") +
  ggtitle("Eviction Rates Across Different Types of Owners and Properties")
```

relative amount within each one, instead of dodged, normalizing for 1 and check it out. 

# Different Owner Types Over Time

Step 1: Create indicator variables for each potential year.
Step 2: If the year part of their date from start to end falls between then put as indicator yes for being an owner during that year. 
Step 3: Calculate how many yeses of each type of owner there were owning apartment complexes in Durham. 
Step 4: See what percentage that corresponds to of overall owners during that year. 
Step 5: Plot the percentages of each type of owner across all years and see if there is a change in the make-up of owners across time. 

```{r}
for (i in 2000:2018)  {
  apt_evictions_eda[ ,paste0(i)] <- NA
}

apt_evictions_eda$Start_year = substr(as.character(apt_evictions_eda$Start_Date),1,4)
apt_evictions_eda$End_year = substr(as.character(apt_evictions_eda$End_Date),1,4)


#How do I create indicator variable?
```

# Showing same data in multiple ways,
show time series and show spatial map but see different things.

# Model

1. Double check that aggs are work, and maybe dropping a few of them. 
2. Looking at how to check it out as parcel times change. 
start with visualization,set as 0 points and look before and after. 
model-> indicator variable or something but later on.

```{r}

```

