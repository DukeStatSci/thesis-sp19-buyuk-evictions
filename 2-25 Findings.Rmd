---
title: "2-25 Findings"
author: "Ekim Buyuk"
date: "2/25/2019"
output: pdf_document
---

```{r}
library(dplyr)
library(readr)
library(ggplot2)
owner_data <- read_csv("owner_data.csv", col_types = cols(X1 = col_skip()))
owner_data$ownership_time = NA
owner_data$ownership_time = difftime(owner_data$End_Date,owner_data$Start_Date,units = "weeks")
owner_data$total_evictions[is.na(owner_data$total_evictions)] <- 0
owner_data$Mailing.Office.State[is.na(owner_data$Mailing.Office.State)] <- "NC"
owner_data$Mailing.Office.State[owner_data$Mailing.Office.State == ""] <- "NC"

```

```{r,include = FALSE}
#Data SetUp
corporate_v_not <- owner_data
corporate_v_not$RHFS.Classifications = as.character(corporate_v_not$RHFS.Classifications)

corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Business Corp"] <- "Corporate"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "LLP, LP, or LLC"] <- "Corporate"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Private Equity"] <- "Corporate"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "REIT"] <- "Corporate"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Fund"] <- "Corporate"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Hedgefund sponser"] <- "Corporate"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Investment Firm"] <- "Corporate"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Other"] <- "Other"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Non-Profit Corp"] <- "Other"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Trustee for estate"] <- "Other"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Estate"] <- "Other"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "GSE"] <- "Other"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Other - DHA"] <- "Other"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Unclear"] <- "Unclear"
corporate_v_not$RHFS.Classifications[corporate_v_not$RHFS.Classifications == "Missing"] <- "Unclear"

pair_wise_tests = corporate_v_not %>% 
  filter(ownership_time > 12) %>%
  filter(RHFS.Classifications == "Corporate" | RHFS.Classifications == "Individual") %>%
  group_by(PARCEL_ID) %>%
  arrange(Start_Date) %>%
  mutate(
    owner_prev = lag(Umbrella.Name),
    type_prev = lag(RHFS.Classifications),
    evic_rate_prev = lag(weekly_evic_rate)
  )

pair_wise_tests$owner_curr = pair_wise_tests$Umbrella.Name
pair_wise_tests$type_curr = pair_wise_tests$RHFS.Classifications
pair_wise_tests$evic_rate_curr = pair_wise_tests$weekly_evic_rate

pair_wise_tests = pair_wise_tests[!is.na(pair_wise_tests$owner_prev),]

indiv_to_corp = pair_wise_tests %>% 
  filter(type_prev == "Individual" & type_curr == "Corporate")
corp_to_indiv = pair_wise_tests %>% 
  filter(type_prev == "Corporate" & type_curr == "Individual")
corp_to_corp = pair_wise_tests %>% 
  filter(type_prev == "Corporate" & type_curr == "Corporate")
```

#Checking Out Changes From Individual to Corporate Ownership

```{r}
t.test(indiv_to_corp$evic_rate_prev, 
       indiv_to_corp$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

This is significant, indicating individuals tend to evict more.
Let's check out by size though...

# Big Landlords 

```{r}
big_landlords <- indiv_to_corp %>% filter(unit_sizes == "large")
t.test(big_landlords$evic_rate_prev, 
       big_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)

#Not significant, negative t indicating corporate landlords evict more
#but not significantly higher eviction rates...
```

# Medium Landlords
```{r}
medium_landlords <- indiv_to_corp %>% filter(unit_sizes == "medium")
t.test(medium_landlords$evic_rate_prev, 
       medium_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)

#Not significant, negative t indicating corporate landlords evict more
#but not significantly higher eviction rates...
```

# Small Landlords

```{r}
small_landlords <- indiv_to_corp %>% filter(unit_sizes == "small")
t.test(small_landlords$evic_rate_prev, 
       small_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)

#Not significant, positive t indicating individual landlords evict more
#but not significantly higher eviction rates...

```

# Tiny Landlords 

```{r}
tiny_landlords <- indiv_to_corp %>% filter(unit_sizes == "tiny")
t.test(tiny_landlords$evic_rate_prev, 
       tiny_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
#Significant!!! Tiny landlords --> p-value  = 0.0062. Individuals tend to evict more 
#than the corporates that buy these properties. 
```

Okay, so basically we are finding significant findings opposite to our hypothesis. Why might this be happening? Can we dig into this phenomenon a little bit more?
Maybe they start to own at times when eviction rates are generally low so it seems lower?? For example, bought up during the financial crisis. How can we restrict to right when they buy up these properties???

#What about if we go the other way? Corporate to Individual?

```{r}
t.test(corp_to_indiv$evic_rate_prev, 
       corp_to_indiv$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

#Not significant, but positive indicating corporates tend to evict more. 

# Big Landlords 

```{r}
big_landlords <- corp_to_corp %>% filter(unit_sizes == "large")
t.test(big_landlords$evic_rate_prev, 
       big_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

Only 2 so not useful. 

# Medium Landlords
```{r}
medium_landlords <- indiv_to_corp %>% filter(unit_sizes == "medium")
t.test(medium_landlords$evic_rate_prev, 
       medium_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

Not significant, negative t indicating individual landlords evict more
but not significantly higher eviction rates...

# Small Landlords

```{r}
small_landlords <- corp_to_indiv %>% filter(unit_sizes == "small")
t.test(small_landlords$evic_rate_prev, 
       small_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

Not significant, positive t indicating corporate landlords evict more
but not significantly higher eviction rates...

# Tiny Landlords 

```{r}
tiny_landlords <- corp_to_indiv %>% filter(unit_sizes == "tiny")
t.test(tiny_landlords$evic_rate_prev, 
       tiny_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)

```

#Positive indicating that corporates evict more but not significant ! 

#Start by looking at highest evictors in aggregate....

# Which owner owns most of the properties in Durham?

```{r,echo=FALSE}
owner_counts <- owner_data %>% count(Umbrella.Name) 
owner_counts <- head(owner_counts[order(-owner_counts$n),],10)
owner_counts

owner_type_counts <- owner_data %>% filter(`2018` == "1") %>% count(RHFS.Classifications) 
owner_type_counts <- head(owner_type_counts[order(-owner_type_counts$n),])
owner_type_counts

owner_type_evictors <- owner_data %>% filter(`2018` == "1") %>% group_by(RHFS.Classifications) %>% summarise(sum_evictions = sum(total_evictions))

owner_type_evictors <- head(owner_type_evictors[order(-owner_type_evictors$sum_evictions),])
owner_type_evictors

owner_evictors <- owner_data %>% filter(`2018` == "1") %>% group_by(Umbrella.Name) %>% summarise(sum_evictions = sum(total_evictions))

owner_evictors <- head(owner_evictors[order(-owner_evictors$sum_evictions),])
owner_evictors

owner_evictor_rates <- owner_data %>% filter(`2018` == "1") %>% group_by(Umbrella.Name) %>% summarise(mean_evictions = mean(weekly_evic_rate))

owner_evictor_rates <- head(owner_evictor_rates[order(-owner_evictor_rates$mean_evictions),])
owner_evictor_rates
```

#Looking at these, it becomes very much a story of owners... how do we think about eviction rates for owners across Durham?

#How do we compare smaller complexes to bigger complexes? 

#How do we think about removing the outliers? 

#Unclear Demographic Could be Really Powerful...

```{r}
ggplot(corporate_v_not %>% filter(unit_sizes == "large"), aes(x=RHFS.Classifications, y=weekly_evic_rate)) + 
  geom_boxplot(outlier.colour="red", outlier.shape=8,
               outlier.size=4) + 
  scale_y_log10() +
  ggtitle("Large Landlords Eviction Rates")

ggplot(corporate_v_not %>% filter(unit_sizes == "medium"), aes(x=RHFS.Classifications, y=weekly_evic_rate)) + 
  geom_boxplot(outlier.colour="red", outlier.shape=8,
               outlier.size=4) + 
  scale_y_log10() +
  ggtitle("Medium Landlords Eviction Rates")

ggplot(corporate_v_not %>% filter(unit_sizes == "small"), aes(x=RHFS.Classifications, y=weekly_evic_rate)) + 
  geom_boxplot(outlier.colour="red", outlier.shape=8,
               outlier.size=4) + 
  scale_y_log10() +
  ggtitle("Small Landlords Eviction Rates")

ggplot(corporate_v_not %>% filter(unit_sizes == "tiny"), aes(x=RHFS.Classifications, y=weekly_evic_rate)) + 
  geom_boxplot(outlier.colour="red", outlier.shape=8,
               outlier.size=4) + 
  scale_y_log10() +
  ggtitle("Tiny Landlords Eviction Rates")
```

# What happens if we count unclear as corporate? Because clearly not individual...

```{r}
#Counting Unclear as Corporate
unclear_as_corp <- corporate_v_not
unclear_as_corp$RHFS.Classifications[unclear_as_corp$RHFS.Classifications == "Unclear"] <- "Corporate"

new_tests = unclear_as_corp %>% 
  filter(ownership_time > 12) %>%
  filter(RHFS.Classifications == "Corporate" | RHFS.Classifications == "Individual") %>%
  group_by(PARCEL_ID) %>%
  arrange(Start_Date) %>%
  mutate(
    owner_prev = lag(Umbrella.Name),
    type_prev = lag(RHFS.Classifications),
    evic_rate_prev = lag(weekly_evic_rate)
  )

new_tests$owner_curr = new_tests$Umbrella.Name
new_tests$type_curr = new_tests$RHFS.Classifications
new_tests$evic_rate_curr = new_tests$weekly_evic_rate

new_tests = new_tests[!is.na(new_tests$owner_prev),]

new_indiv_to_corp = new_tests %>% 
  filter(type_prev == "Individual" & type_curr == "Corporate")
```

```{r}
t.test(indiv_to_corp$evic_rate_prev, 
       indiv_to_corp$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

# What happens when you switch from in-state to out-of-state owners?

```{r}
in_to_out = owner_data %>% 
  filter(ownership_time > 12) %>%
  group_by(PARCEL_ID) %>%
  arrange(Start_Date) %>%
  mutate(
    owner_prev = lag(Umbrella.Name),
    type_prev = lag(Mailing.Office.State),
    evic_rate_prev = lag(weekly_evic_rate)
  )

in_to_out$owner_curr = in_to_out$Umbrella.Name
in_to_out$type_curr = in_to_out$Mailing.Office.State
in_to_out$evic_rate_curr = in_to_out$weekly_evic_rate

in_to_out = in_to_out[!is.na(in_to_out$owner_prev),]

in_to_out_state = in_to_out %>% 
  filter(type_prev == "NC" & type_curr != "NC")
```

```{r}
t.test(in_to_out_state$evic_rate_prev, 
       in_to_out_state$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

#A Negative T-value suggests that Out of state owners evict more but not significant. 

#Does this vary across apartment sizes??

```{r}
big_landlords <- in_to_out_state %>% filter(unit_sizes  == "large")
t.test(big_landlords$evic_rate_prev, 
       big_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

#A Negative T-value suggests that Out of state owners evict more but not significant. 

```{r}
medium_landlords <- in_to_out_state %>% filter(unit_sizes  == "medium")
t.test(medium_landlords$evic_rate_prev, 
       medium_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

#A Negative T-value suggests that Out of state owners evict more but not significant. 

```{r}
small_landlords <- in_to_out_state %>% filter(unit_sizes  == "small")
t.test(small_landlords$evic_rate_prev, 
       small_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

#A Positive T-value suggests that In-state owners evict more but not significant. 

```{r}
tiny_landlords <- in_to_out_state %>% filter(unit_sizes  == "tiny")
t.test(tiny_landlords$evic_rate_prev, 
       tiny_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
```

#A Negative T-value suggests that Out of state owners evict more but not significant. 

# Looking at current owners....

#What about corporate to corporate? 

```{r}
t.test(corp_to_corp$evic_rate_prev, 
       corp_to_corp$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
small_landlords <- corp_to_corp %>% filter(unit_sizes  == "small")

t.test(small_landlords$evic_rate_prev, 
       small_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
#significant in the opposite way. 
big_landlords <- corp_to_corp %>% filter(unit_sizes  == "large")

t.test(big_landlords$evic_rate_prev, 
       big_landlords$evic_rate_curr, 
       paired=TRUE, 
       conf.level=0.95)
#super significant saying 
```




`